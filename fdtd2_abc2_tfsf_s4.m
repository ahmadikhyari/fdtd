clear
clc

mu0 = pi*4e-7; vp = 299792458; ep0 = 1/(vp^2*mu0);
dx = 0.1;
dy = 0.1;
dt = dx/vp/sqrt(2);

xmin = 0;  xmax = 20;
ymin = 0;  ymax = 20;
x = (xmin:dx:xmax);
y = (ymin:dy:ymax);
i = length(x);
j = length(y);
mu(1:j,1:i) = 1*mu0; ep(1:j,1:i) = 1*ep0;
sigm(1:j,1:i) = 0; sige(1:j,1:i) = 0;
mu2(1:j,1:i) = 1*mu0; ep2(1:j,1:i) = 1*ep0;
sigm2(1:j,1:i) = 0; sige2(1:j,1:i) = 0;

f = 278e6;

xs = 31;
ys = 31;
ia = 51; ja = 51;
ib = 150; jb = 150;
is = 91; js = 91;
ir = 110; jr = 110;
mu2(js:jr,is:ir) = 1*mu0; ep2(js:jr,is:ir) = 1*ep0;
sigm2(js:jr,is:ir) = 0; sige2(js:jr,is:ir) = 1e80;

Ezincold(1:j,1:i)=0.0;
Hxincnow(1:j-1,1:i)=0.0;
Hyincnow(1:j,1:i-1)=0.0;
Ezincnow(1:j,1:i)=0.0;
Hxincnew(1:j-1,1:i)=0.0;
Hyincnew(1:j,1:i-1)=0.0;
Ezincnew(1:j,1:i)=0.0;

Ezold(1:j,1:i)=0.0;
Hxnow(1:j-1,1:i)=0.0;
Hynow(1:j,1:i-1)=0.0;
Eznow(1:j,1:i)=0.0;
Hxnew(1:j-1,1:i)=0.0;
Hynew(1:j,1:i-1)=0.0;
Eznew(1:j,1:i)=0.0;

Ezold2(1:j,1:i)=0.0;
Hxnow2(1:j-1,1:i)=0.0;
Hynow2(1:j,1:i-1)=0.0;
Eznow2(1:j,1:i)=0.0;
Hxnew2(1:j-1,1:i)=0.0;
Hynew2(1:j,1:i-1)=0.0;
Eznew2(1:j,1:i)=0.0;

myVideo = VideoWriter('fdtd2');
open(myVideo)

for n=0:1000
    Ezincnow(ys,xs) = sin(2*pi*f*n*dt/2);
    
    Hxincnew(1:j-1,1:i) = Hxincnow(1:j-1,1:i)...
        - dt/mu0/dy * (Ezincnow(2:j,1:i)-Ezincnow(1:j-1,1:i));
    Hyincnew(1:j,1:i-1) = Hyincnow(1:j,1:i-1)...
        + dt/mu0/dx * (Ezincnow(1:j,2:i)-Ezincnow(1:j,1:i-1));
    
    Hxnew(1:j-1,1:i)...
        = (2*mu(1:j-1,1:i)-sigm(1:j-1,1:i)*dt)...
        ./ (2*mu(1:j-1,1:i)+sigm(1:j-1,1:i)*dt) .* Hxnow(1:j-1,1:i)...
        - 2*dt ./ (2*mu(1:j-1,1:i)+sigm(1:j-1,1:i)*dt)/dy...
        .* (Eznow(2:j,1:i)-Eznow(1:j-1,1:i));
    Hynew(1:j,1:i-1)...
        = (2*mu(1:j,1:i-1)-sigm(1:j,1:i-1)*dt)...
        ./ (2*mu(1:j,1:i-1)+sigm(1:j,1:i-1)*dt) .* Hynow(1:j,1:i-1)...
        + 2*dt ./ (2*mu(1:j,1:i-1)+sigm(1:j,1:i-1)*dt)/dx...
        .* (Eznow(1:j,2:i)-Eznow(1:j,1:i-1));
    
    Hxnew2(1:j-1,1:i)...
        = (2*mu2(1:j-1,1:i)-sigm2(1:j-1,1:i)*dt)...
        ./ (2*mu2(1:j-1,1:i)+sigm2(1:j-1,1:i)*dt) .* Hxnow2(1:j-1,1:i)...
        - 2*dt ./ (2*mu2(1:j-1,1:i)+sigm2(1:j-1,1:i)*dt)/dy...
        .* (Eznow2(2:j,1:i)-Eznow2(1:j-1,1:i));
    Hynew2(1:j,1:i-1)...
        = (2*mu2(1:j,1:i-1)-sigm2(1:j,1:i-1)*dt)...
        ./ (2*mu2(1:j,1:i-1)+sigm2(1:j,1:i-1)*dt) .* Hynow2(1:j,1:i-1)...
        + 2*dt ./ (2*mu2(1:j,1:i-1)+sigm2(1:j,1:i-1)*dt)/dx...
        .* (Eznow2(1:j,2:i)-Eznow2(1:j,1:i-1));
    
    Hxnew(ja-1,ia:ib)...
        = Hxnew(ja-1,ia:ib)...
        + 2*dt ./ (2*mu(ja-1,ia:ib)+sigm(ja-1,ia:ib)*dt)/dy...
        .* (Ezincnow(ja,ia:ib));
    Hynew(ja:jb,ia-1)...
        = Hynew(ja:jb,ia-1) ...
        - 2*dt ./ (2*mu(ja:jb,ia-1)+sigm(ja:jb,ia-1)*dt)/dx...
        .* (Ezincnow(ja:jb,ia));
    Hxnew(jb,ia:ib)...
        = Hxnew(jb,ia:ib)...
        - 2*dt ./ (2*mu(jb,ia:ib)+sigm(jb,ia:ib)*dt)/dy...
        .* (Ezincnow(jb,ia:ib));
    Hynew(ja:jb,ib)...
        = Hynew(ja:jb,ib) ...
        + 2*dt ./ (2*mu(ja:jb,ib)+sigm(ja:jb,ib)*dt)/dx...
        .* (Ezincnow(ja:jb,ib));
    
    Hxnew2(ja-1,ia:ib)...
        = Hxnew2(ja-1,ia:ib)...
        + 2*dt ./ (2*mu2(ja-1,ia:ib)+sigm2(ja-1,ia:ib)*dt)/dy...
        .* (Ezincnow(ja,ia:ib));
    Hynew2(ja:jb,ia-1)...
        = Hynew2(ja:jb,ia-1) ...
        - 2*dt ./ (2*mu2(ja:jb,ia-1)+sigm2(ja:jb,ia-1)*dt)/dx...
        .* (Ezincnow(ja:jb,ia));
    Hxnew2(jb,ia:ib)...
        = Hxnew2(jb,ia:ib)...
        - 2*dt ./ (2*mu2(jb,ia:ib)+sigm2(jb,ia:ib)*dt)/dy...
        .* (Ezincnow(jb,ia:ib));
    Hynew2(ja:jb,ib)...
        = Hynew2(ja:jb,ib) ...
        + 2*dt ./ (2*mu2(ja:jb,ib)+sigm2(ja:jb,ib)*dt)/dx...
        .* (Ezincnow(ja:jb,ib));
    
    Hxincnow = Hxincnew;
    Hyincnow = Hyincnew;
    Hxnow = Hxnew;
    Hynow = Hynew;
    Hxnow2 = Hxnew2;
    Hynow2 = Hynew2;
    
    Ezincnew(2:j-1,2:i-1) = Ezincnow(2:j-1,2:i-1)...
        + dt/ep0 * (((Hyincnow(2:j-1,2:i-1)-Hyincnow(2:j-1,1:i-2))/dx)...
        - ((Hxincnow(2:j-1,2:i-1)-Hxincnow(1:j-2,2:i-1))/dy));
    
    Eznew(2:j-1,2:i-1)...
        = (2*ep(2:j-1,2:i-1)-sige(2:j-1,2:i-1)*dt)...
        ./ (2*ep(2:j-1,2:i-1)+sige(2:j-1,2:i-1)*dt) .* Eznow(2:j-1,2:i-1)...
        + 2*dt ./ (2*ep(2:j-1,2:i-1)+sige(2:j-1,2:i-1)*dt)...
        .* (((Hynow(2:j-1,2:i-1)-Hynow(2:j-1,1:i-2))/dx)...
        - ((Hxnow(2:j-1,2:i-1)-Hxnow(1:j-2,2:i-1))/dy));
    
    Eznew2(2:j-1,2:i-1)...
        = (2*ep2(2:j-1,2:i-1)-sige2(2:j-1,2:i-1)*dt)...
        ./ (2*ep2(2:j-1,2:i-1)+sige2(2:j-1,2:i-1)*dt) .* Eznow2(2:j-1,2:i-1)...
        + 2*dt ./ (2*ep2(2:j-1,2:i-1)+sige2(2:j-1,2:i-1)*dt)...
        .* (((Hynow2(2:j-1,2:i-1)-Hynow2(2:j-1,1:i-2))/dx)...
        - ((Hxnow2(2:j-1,2:i-1)-Hxnow2(1:j-2,2:i-1))/dy));
    
    Eznew(ja,ia)...
        = Eznew(ja,ia)...
        - 2*dt ./ (2*ep(ja,ia) + sige(ja,ia)*dt) .* Hyincnow(ja,ia-1)/dx...
        + 2*dt ./ (2*ep(ja,ia) + sige(ja,ia)*dt) .* Hxincnow(ja-1,ia)/dy;
    Eznew(ja+1:jb-1,ia)...
        = Eznew(ja+1:jb-1,ia)...
        - 2*dt ./ (2*ep(ja+1:jb-1,ia)+sige(ja+1:jb-1,ia)*dt)...
        .* (Hyincnow(ja+1:jb-1,ia-1)/dx);
    Eznew(jb,ia)...
        = Eznew(jb,ia)...
        - 2*dt ./ (2*ep(jb,ia)+sige(jb,ia)*dt) .* Hyincnow(jb,ia-1)/dx...
        - 2*dt ./ (2*ep(jb,ia)+sige(jb,ia)*dt) .* Hxincnow(jb,ia)/dy;
    Eznew(jb,ia+1:ib-1)...
        = Eznew(jb,ia+1:ib-1)...
        - 2*dt ./ (2*ep(jb,ia+1:ib-1)+sige(jb,ia+1:ib-1)*dt)...
        .* Hxincnow(jb,ia+1:ib-1)/dy;
    Eznew(jb,ib)...
        = Eznew(jb,ib)...
        + 2*dt ./ (2*ep(jb,ib)+sige(jb,ib)*dt) .* Hyincnow(jb,ib)/dx ...
        - 2*dt ./ (2*ep(jb,ib)+sige(jb,ib)*dt) .* Hxincnow(jb,ib)/dy;
    Eznew(ja+1:jb-1,ib)...
        = Eznew(ja+1:jb-1,ib)...
        + 2*dt ./ (2*ep(ja+1:jb-1,ib)+sige(ja+1:jb-1,ib)*dt)...
        .* (Hyincnow(ja+1:jb-1,ib)/dx);
    Eznew(ja,ib)...
        = Eznew(ja,ib)...
        + 2*dt ./ (2*ep(ja,ib)+sige(ja,ib)*dt) .* Hyincnow(ja,ib)/dx...
        + 2*dt ./ (2*ep(ja,ib)+sige(ja,ib)*dt) .* Hxincnow(ja-1,ib)/dy;
    Eznew(ja,ia+1:ib-1)...
        = Eznew(ja,ia+1:ib-1)...
        + 2*dt ./ (2*ep(ja,ia+1:ib-1)+sige(ja,ia+1:ib-1)*dt)...
        .* Hxincnow(ja-1,ia+1:ib-1)/dy;
    
    Eznew2(ja,ia)...
        = Eznew2(ja,ia)...
        - 2*dt ./ (2*ep2(ja,ia) + sige2(ja,ia)*dt) .* Hyincnow(ja,ia-1)/dx...
        + 2*dt ./ (2*ep2(ja,ia) + sige2(ja,ia)*dt) .* Hxincnow(ja-1,ia)/dy;
    Eznew2(ja+1:jb-1,ia)...
        = Eznew2(ja+1:jb-1,ia)...
        - 2*dt ./ (2*ep2(ja+1:jb-1,ia)+sige2(ja+1:jb-1,ia)*dt)...
        .* (Hyincnow(ja+1:jb-1,ia-1)/dx);
    Eznew2(jb,ia)...
        = Eznew2(jb,ia)...
        - 2*dt ./ (2*ep2(jb,ia)+sige2(jb,ia)*dt) .* Hyincnow(jb,ia-1)/dx...
        - 2*dt ./ (2*ep2(jb,ia)+sige2(jb,ia)*dt) .* Hxincnow(jb,ia)/dy;
    Eznew2(jb,ia+1:ib-1)...
        = Eznew2(jb,ia+1:ib-1)...
        - 2*dt ./ (2*ep2(jb,ia+1:ib-1)+sige2(jb,ia+1:ib-1)*dt)...
        .* Hxincnow(jb,ia+1:ib-1)/dy;
    Eznew2(jb,ib)...
        = Eznew2(jb,ib)...
        + 2*dt ./ (2*ep2(jb,ib)+sige2(jb,ib)*dt) .* Hyincnow(jb,ib)/dx ...
        - 2*dt ./ (2*ep2(jb,ib)+sige2(jb,ib)*dt) .* Hxincnow(jb,ib)/dy;
    Eznew2(ja+1:jb-1,ib)...
        = Eznew2(ja+1:jb-1,ib)...
        + 2*dt ./ (2*ep2(ja+1:jb-1,ib)+sige2(ja+1:jb-1,ib)*dt)...
        .* (Hyincnow(ja+1:jb-1,ib)/dx);
    Eznew2(ja,ib)...
        = Eznew2(ja,ib)...
        + 2*dt ./ (2*ep2(ja,ib)+sige2(ja,ib)*dt) .* Hyincnow(ja,ib)/dx...
        + 2*dt ./ (2*ep2(ja,ib)+sige2(ja,ib)*dt) .* Hxincnow(ja-1,ib)/dy;
    Eznew2(ja,ia+1:ib-1)...
        = Eznew2(ja,ia+1:ib-1)...
        + 2*dt ./ (2*ep2(ja,ia+1:ib-1)+sige2(ja,ia+1:ib-1)*dt)...
        .* Hxincnow(ja-1,ia+1:ib-1)/dy;
    
    Ezincnew(2:j-1,1) = -Ezincold(2:j-1,2)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Ezincnew(2:j-1,2)+Ezincold(2:j-1,1))...
        + 2*dx/(dx+vp*dt)*(Ezincnow(2:j-1,1)+Ezincnow(2:j-1,2))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Ezincnow(3:j,1)-2*Ezincnow(2:j-1,1)+Ezincnow(1:j-2,1)...
        + Ezincnow(3:j,2)-2*Ezincnow(2:j-1,2)+Ezincnow(1:j-2,2));
    Ezincnew(2:j-1,i) = -Ezincold(2:j-1,i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Ezincnew(2:j-1,i-1)+Ezincold(2:j-1,i))...
        + 2*dx/(dx+vp*dt)*(Ezincnow(2:j-1,i)+Ezincnow(2:j-1,i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Ezincnow(3:j,i)-2*Ezincnow(2:j-1,i)+Ezincnow(1:j-2,i)...
        + Ezincnow(3:j,i-1)-2*Ezincnow(2:j-1,i-1)+Ezincnow(1:j-2,i-1));
    Ezincnew(1,2:i-1) = -Ezincold(2,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Ezincnew(2,2:i-1)+Ezincold(1,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Ezincnow(1,2:i-1)+Ezincnow(2,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Ezincnow(1,3:i)-2*Ezincnow(1,2:i-1)+Ezincnow(1,1:i-2)...
        + Ezincnow(2,3:i)-2*Ezincnow(2,2:i-1)+Ezincnow(2,1:i-2));
    Ezincnew(j,2:i-1) = -Ezincold(j-1,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Ezincnew(j-1,2:i-1)+Ezincold(j,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Ezincnow(j,2:i-1)+Ezincnow(j-1,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Ezincnow(j,3:i)-2*Ezincnow(j,2:i-1)+Ezincnow(j,1:i-2)...
        + Ezincnow(j-1,3:i)-2*Ezincnow(j-1,2:i-1)+Ezincnow(j-1,1:i-2));
    
    Eznew(2:j-1,1) = -Ezold(2:j-1,2)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew(2:j-1,2)+Ezold(2:j-1,1))...
        + 2*dx/(dx+vp*dt)*(Eznow(2:j-1,1)+Eznow(2:j-1,2))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow(3:j,1)-2*Eznow(2:j-1,1)+Eznow(1:j-2,1)...
        + Eznow(3:j,2)-2*Eznow(2:j-1,2)+Eznow(1:j-2,2));
    Eznew(2:j-1,i) = -Ezold(2:j-1,i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew(2:j-1,i-1)+Ezold(2:j-1,i))...
        + 2*dx/(dx+vp*dt)*(Eznow(2:j-1,i)+Eznow(2:j-1,i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow(3:j,i)-2*Eznow(2:j-1,i)+Eznow(1:j-2,i)...
        + Eznow(3:j,i-1)-2*Eznow(2:j-1,i-1)+Eznow(1:j-2,i-1));
    Eznew(1,2:i-1) = -Ezold(2,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew(2,2:i-1)+Ezold(1,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Eznow(1,2:i-1)+Eznow(2,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow(1,3:i)-2*Eznow(1,2:i-1)+Eznow(1,1:i-2)...
        + Eznow(2,3:i)-2*Eznow(2,2:i-1)+Eznow(2,1:i-2));
    Eznew(j,2:i-1) = -Ezold(j-1,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew(j-1,2:i-1)+Ezold(j,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Eznow(j,2:i-1)+Eznow(j-1,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow(j,3:i)-2*Eznow(j,2:i-1)+Eznow(j,1:i-2)...
        + Eznow(j-1,3:i)-2*Eznow(j-1,2:i-1)+Eznow(j-1,1:i-2));
    
    Eznew2(2:j-1,1) = -Ezold2(2:j-1,2)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew2(2:j-1,2)+Ezold2(2:j-1,1))...
        + 2*dx/(dx+vp*dt)*(Eznow2(2:j-1,1)+Eznow2(2:j-1,2))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow2(3:j,1)-2*Eznow2(2:j-1,1)+Eznow2(1:j-2,1)...
        + Eznow2(3:j,2)-2*Eznow2(2:j-1,2)+Eznow2(1:j-2,2));
    Eznew2(2:j-1,i) = -Ezold2(2:j-1,i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew2(2:j-1,i-1)+Ezold2(2:j-1,i))...
        + 2*dx/(dx+vp*dt)*(Eznow2(2:j-1,i)+Eznow2(2:j-1,i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow2(3:j,i)-2*Eznow2(2:j-1,i)+Eznow2(1:j-2,i)...
        + Eznow2(3:j,i-1)-2*Eznow2(2:j-1,i-1)+Eznow2(1:j-2,i-1));
    Eznew2(1,2:i-1) = -Ezold2(2,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew2(2,2:i-1)+Ezold2(1,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Eznow2(1,2:i-1)+Eznow2(2,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow2(1,3:i)-2*Eznow2(1,2:i-1)+Eznow2(1,1:i-2)...
        + Eznow2(2,3:i)-2*Eznow2(2,2:i-1)+Eznow2(2,1:i-2));
    Eznew2(j,2:i-1) = -Ezold2(j-1,2:i-1)...
        - ((dx-vp*dt)/(dx+vp*dt))*(Eznew2(j-1,2:i-1)+Ezold2(j,2:i-1))...
        + 2*dx/(dx+vp*dt)*(Eznow2(j,2:i-1)+Eznow2(j-1,2:i-1))...
        + (dx*(vp*dt)^2/2/dy^2/(dx+vp*dt))...
        * (Eznow2(j,3:i)-2*Eznow2(j,2:i-1)+Eznow2(j,1:i-2)...
        + Eznow2(j-1,3:i)-2*Eznow2(j-1,2:i-1)+Eznow2(j-1,1:i-2));
    
    figure(1);
    colormap((gray));
    
    subplot(2,2,1);
    imagesc(x,y,(abs(Eznew)),[0 1]);
    axis('square');
    
    subplot(2,2,2);
    imagesc(x,y,(abs(Ezincnew)),[0 1]);
    axis('square');
    
    subplot(2,2,3);
    imagesc(x,y,(abs(Eznew2)),[0 1]);
    axis('square');
    
    subplot(2,2,4);
    imagesc(x,y,(abs(Eznew2-Eznew)),[0 1]);
    axis('square');
    
    frame = getframe(gcf);
    writeVideo(myVideo,frame);
    
    Ezincold = Ezincnow;
    Ezincnow = Ezincnew;
    Ezold = Eznow;
    Eznow = Eznew;
    Ezold2 = Eznow2;
    Eznow2 = Eznew2;
end

close(myVideo)